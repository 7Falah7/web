<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SpacedRep â€” Ù…Ù†Ø´Ø¦ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ØªØ¨Ø§Ø¹Ø¯</title>

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Ù…ÙƒØªØ¨Ø§Øª PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#f5fbfc;
      --card:#ffffff;
      --muted:#FFDC55;
      --text:#000000;

      /* Ù„ÙˆØ­Ø© Ø£Ù„ÙˆØ§Ù† Ø­ÙŠÙˆÙŠØ© - Ø³Ù…Ø§ÙˆÙŠ/ÙÙŠØ±ÙˆØ²ÙŠ */
      --primary: #06b6d4;   /* cyan-500 */
      --primary-600: #0891b2;
      --accent: #067d75;    /* ØªØ¯Ø±Ø¬ Ø«Ø§Ù†ÙˆÙŠ */
      --success: #16a34a;
      --danger: #ef4444;

      --glass: rgba(6,182,212,0.08);
      --radius: 12px;
      --shadow: 0 8px 28px rgba(3,18,25,0.06);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      padding:20px;
      background: linear-gradient(180deg, #f0fcff 0%, var(--bg) 100%);
      font-family: 'Cairo', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .container{max-width:1200px;margin:0 auto}

    header{
      background:linear-gradient(90deg,var(--primary),var(--primary-600));
      color:white;
      padding:20px;border-radius:14px;box-shadow:var(--shadow);
      display:flex;gap:16px;align-items:center;justify-content:space-between;
      flex-wrap:wrap;
    }
    header .brand{display:flex;align-items:center;gap:12px}
    header .brand .logo{
      width:54px;height:54px;border-radius:10px;background:linear-gradient(135deg,rgba(255,255,255,0.12),rgba(255,255,255,0.04));
      display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:inset 0 -6px 20px rgba(255,255,255,0.05);
    }
    header h1{margin:0;font-size:1.1rem;font-weight:700;letter-spacing:0.2px}
    header p{margin:0;color:rgba(255,255,255,0.9);font-size:0.95rem}

    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:18px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);
      border: 1px solid rgba(6,6,6,0.03);
    }

    label{display:block;margin-bottom:8px;font-weight:600;color:var(--text)}
    input,select,textarea{
      width:100%;padding:11px 12px;border-radius:10px;border:1px solid rgba(6,6,6,0.06);
      background:transparent;color:var(--text);font-size:0.95rem;
    }

    .row{display:flex;gap:12px;align-items:center}
    .col{flex:1}

    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    .btn{
      display:inline-flex;gap:10px;align-items:center;padding:9px 14px;border-radius:10px;border:none;
      background:var(--primary);color:#fff;font-weight:600;cursor:pointer;box-shadow:0 6px 16px rgba(6,182,212,0.12);
      transition:transform .08s ease, box-shadow .12s ease, opacity .12s;
    }
    .btn:hover{transform:translateY(-2px)}
    .btn:active{transform:translateY(0)}
    .btn.small{padding:6px 9px;font-size:0.9rem}
    .btn.ghost{
      background:transparent;color:var(--text);border:1px solid rgba(6,6,6,0.06);box-shadow:none;font-weight:600;
    }
    .btn.ghost:hover{background:var(--glass)}
    .btn.warn{background:var(--danger);box-shadow:0 6px 18px rgba(239,68,68,0.12)}

    .small{font-size:0.86rem;color:var(--muted);margin-top:8px}

    /* Books list */
    #booksList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
    li.book-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;border:1px solid rgba(6,6,6,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.65),transparent)}
    .book-meta{display:flex;flex-direction:column}
    .book-meta .title{font-weight:700;color:var(--text)}
    .book-meta .meta{font-size:0.85rem;color:var(--muted)}

    /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .schedule-table-container{overflow:auto;border-radius:8px;margin-top:12px}
    table{width:100%;border-collapse:collapse;min-width:900px;table-layout:fixed;font-size:0.95rem}
    th,td{padding:10px;border-bottom:1px solid rgba(6,6,6,0.04);text-align:center;vertical-align:middle}
    th{position:sticky;top:0;background:linear-gradient(90deg,var(--primary),var(--primary-600));color:#fff;font-weight:700}
    th:nth-child(2),td:nth-child(2){min-width:180px} /* ØªØ§Ø±ÙŠØ® Ø£Ø¹Ø±Ø¶ */
    td{background:transparent}
    tr.save td{background:linear-gradient(90deg, rgba(6,182,212,0.03), transparent)}
    tr.review td{background:linear-gradient(90deg, rgba(6,125,117,0.03), transparent)}
    tr.rest td{background:linear-gradient(90deg, rgba(239,68,68,0.03), transparent)}
    tr.done td{background:linear-gradient(90deg, rgba(16,185,129,0.06), transparent)}

    /* Timer */
    .timer-box{display:flex;flex-direction:column;gap:12px;align-items:center}
    .timer-display{font-size:2.4rem;color:var(--primary);font-weight:800}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .notice{padding:12px;border-radius:10px;background:linear-gradient(90deg,#fff7df,#fff3d7);border:1px solid rgba(0,0,0,0.03);color:#6b4c00}

    footer{margin-top:20px;text-align:center;color:var(--muted);font-size:0.9rem}

    /* dark mode */
    body.dark{
      --bg:#021517;
      --card:#071823;
      --text:#e6f6f7;
      --muted:#98a8ad;
      --glass: rgba(255,255,255,0.03);
    }
    body.dark header{box-shadow:none}
    body.dark .card{border:1px solid rgba(255,255,255,0.04)}
    body.dark input,body.dark select,body.dark textarea{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
    body.dark .btn.ghost{background:rgba(255,255,255,0.03);border-color:rgba(255,255,255,0.06);color:var(--text)}
    body.dark th{background:linear-gradient(90deg,#0ea5b7,#028090)}

    /* Ù„ÙˆØ­Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø³ÙŠØ·Ø© */
    .stats{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .stat{background:linear-gradient(180deg,rgba(6,182,212,0.06),transparent);padding:10px;border-radius:10px;min-width:120px;text-align:center}

    @media (max-width:720px){
      header{padding:14px}
      .btn{width:100%}
      .controls .btn{flex:1}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo"><i class="fas fa-sync-alt" style="transform:scaleX(-1)"></i></div>
        <div>
          <h1>SpacedRep</h1>
          <p class="small">Ù…Ù†Ø´Ø¦ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ØªØ¨Ø§Ø¹Ø¯ â€” ÙˆØ§Ø¬Ù‡Ø© Ø³Ø±ÙŠØ¹Ø©ØŒ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ®ØµÙŠØµØŒ ÙˆÙ…ØªØ¬Ø§ÙˆØ¨Ø©</p>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="small">Ø¬Ø§Ù‡Ø² Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø­ÙØ¸Ùƒ Ø§Ù„Ø°ÙƒÙŠØ©</div>
      </div>
    </header>

    <div class="grid">
      <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
      <div>
        <div id="notice" class="card notice" style="display:none"></div>

        <div class="card" aria-labelledby="add-book-title">
          <h3 id="add-book-title">â• Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ / Ù…Ø§Ø¯Ø©</h3>

          <label>Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨</label>
          <input id="bookName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡">

          <div class="row" style="margin-top:12px">
            <div class="col">
              <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙØ­Ø§Øª</label>
              <input id="bookTotal" type="number" min="1" value="200">
            </div>
            <div class="col">
              <label>Ø§Ù„ØµÙØ­Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹</label>
              <input id="bookDaily" type="number" min="1" value="10">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="startDate" type="date">
          </div>

          <div style="margin-top:12px">
            <label>Ø£ÙŠØ§Ù… Ø§Ù„Ø±Ø§Ø­Ø© (Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ÙŠÙˆÙ…)</label>
            <select id="restDays" multiple>
              <option value="0">Ø§Ù„Ø£Ø­Ø¯</option><option value="1">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option value="2">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
              <option value="3">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option value="4">Ø§Ù„Ø®Ù…ÙŠØ³</option><option value="5">Ø§Ù„Ø¬Ù…Ø¹Ø©</option><option value="6">Ø§Ù„Ø³Ø¨Øª</option>
            </select>
          </div>

          <div style="margin-top:12px">
            <label>ÙØªØ±Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Ø£ÙŠØ§Ù… Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„) â€” Ù…Ø«Ø§Ù„: <code>1,3,7,15</code></label>
            <input id="intervals" type="text" placeholder="1,3,7" value="1,3,7,15">
          </div>

          <div class="controls" style="margin-top:14px">
            <button id="addBtn" class="btn"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©</button>
            <button id="generateBtn" class="btn"><i class="fas fa-calendar-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</button>
            <button id="darkBtn" class="btn ghost"><i class="fas fa-moon"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù…</button>
          </div>

          <div class="small">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ. Ù„Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆÙ…Ø²Ø§Ù…Ù†Ø©ØŒ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø±Ø¨Ø· Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø®Ø¯Ù…Ø© Ø³Ø­Ø§Ø¨ÙŠØ©.</div>
        </div>

        <div id="booksCard" class="card" style="display:none; margin-top:14px">
          <h3>ğŸ“š Ø§Ù„ÙƒØªØ¨</h3>
          <ul id="booksList"></ul>
          <div class="controls" style="margin-top:10px">
            <button id="clearBooks" class="btn ghost">Ø­Ø°Ù Ø§Ù„ÙƒØªØ¨</button>
            <button id="exportAllCsv" class="btn ghost"><i class="fas fa-file-csv"></i> ØªÙ†Ø²ÙŠÙ„ CSV</button>
            <button id="exportAllPdf" class="btn ghost"><i class="fas fa-file-pdf"></i> ØªÙ†Ø²ÙŠÙ„ PDF</button>
          </div>
        </div>

        <div id="schedulesCard" class="card" style="display:none; margin-top:14px">
          <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
            <h3 style="margin:0">ğŸ“… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</h3>
            <div class="stats" style="margin-left:auto">
              <!-- Ù…Ø«Ø§Ù„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø© (ÙŠÙÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§) -->
              <div class="stat"><div class="small">Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</div><div style="font-weight:700" id="statDone">0</div></div>
              <div class="stat"><div class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</div><div style="font-weight:700" id="statTotal">0</div></div>
            </div>
          </div>

          <div id="schedulesArea" style="margin-top:12px"></div>

          <div class="controls" style="margin-top:12px">
            <button id="downloadAllCsv" class="btn ghost">ØªÙ†Ø²ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ CSV</button>
            <button id="downloadAllPdf" class="btn ghost">ØªÙ†Ø²ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ PDF</button>
          </div>
        </div>
      </div>

      <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„Ù…Ø¤Ù‚Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
      <aside>
        <div class="card timer-box">
          <h3 style="margin:0">â±ï¸ Ø§Ù„Ù…Ø¤Ù‚Øª</h3>

          <label style="width:100%;margin-top:8px">Ø§Ù„ÙˆØ¶Ø¹</label>
          <select id="timerMode" style="width:100%;padding:10px;border-radius:10px">
            <option value="pomodoro">Pomodoro</option>
            <option value="custom">Ù…Ø®ØµØµ</option>
            <option value="continuous">Ù…Ø³ØªÙ…Ø±</option>
          </select>

          <div id="pom" style="margin-top:10px;width:100%">
            <div class="row">
              <div class="col"><label>Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ø¹Ù…Ù„</label><input id="pomWork" type="number" min="1" value="25"></div>
              <div class="col"><label>Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</label><input id="pomBreak" type="number" min="1" value="5"></div>
            </div>
          </div>

          <div id="custom" style="display:none;margin-top:8px;width:100%">
            <label>Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
            <input id="customMin" type="number" min="1" value="30">
          </div>

          <div style="margin-top:10px;text-align:center">
            <div class="timer-display" id="timerText">00:00</div>
            <div class="small">Ø§Ù„Ø­Ø§Ù„Ø©: <span id="timerState">Ù…ØªÙˆÙ‚Ù</span></div>
          </div>

          <div style="width:100%;display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap">
            <button id="startTimer" class="btn small"><i class="fas fa-play"></i> Ø¨Ø¯Ø¡</button>
            <button id="pauseTimer" class="btn small ghost"><i class="fas fa-pause"></i> Ø¥ÙŠÙ‚Ø§Ù</button>
            <button id="skipTimer" class="btn small ghost">ØªØ®Ø·ÙŠ</button>
            <button id="resetTimer" class="btn small warn">Ø¥Ø¹Ø§Ø¯Ø©</button>
          </div>

          <div style="margin-top:10px;width:100%" class="small">
            <label><input id="notifyChk" type="checkbox"> Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨</label><br>
            <label><input id="soundChk" type="checkbox" checked> ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</label>
          </div>

          <div style="margin-top:8px;width:100%" class="small">Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: <strong id="sessionCount">0</strong></div>

          <div style="width:100%;display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap">
            <button id="resetSessions" class="btn ghost small">Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</button>
            <button id="resetSchedules" class="btn ghost small">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</button>
            <button id="resetAll" class="btn warn small">Ø¥Ø¹Ø§Ø¯Ø© Ø´Ø§Ù…Ù„Ø©</button>
          </div>

        </div>
      </aside>
    </div>

    <footer>Â© SpacedRep â€” ÙˆØ§Ø¬Ù‡Ø© Ù…ÙØ­Ø³Ù‘Ù†Ø© ÙˆØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„Ù‡Ø§ØªÙ</footer>
  </div>

  <!-- ===== JavaScript (Ù„Ù… Ø£ØºÙŠØ± ÙˆØ¸Ø§Ø¦ÙÙƒ â€” Ø§Ù„ÙƒÙˆØ¯ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª ØªØ¹Ù…Ù„) ===== -->
<script>
(() => {
  // ----- Storage keys -----
  const K_BOOKS = 'sr_books_v1';
  const K_SCHEDULES = 'sr_schedules_v1';
  const K_SESSIONS = 'sr_sessions_v1';
  const K_SETTINGS = 'sr_settings_v1';

  // ----- App state -----
  const state = {
    books: JSON.parse(localStorage.getItem(K_BOOKS) || '[]'),
    schedules: JSON.parse(localStorage.getItem(K_SCHEDULES) || '[]'),
    sessions: parseInt(localStorage.getItem(K_SESSIONS) || '0'),
    settings: JSON.parse(localStorage.getItem(K_SETTINGS) || '{}'),
    timer: { intervalId: null, timeLeft: 0, running: false, isWork: true }
  };

  // ----- DOM refs -----
  const el = id => document.getElementById(id);
  const addBtn = el('addBtn'), generateBtn = el('generateBtn'), darkBtn = el('darkBtn');
  const booksCard = el('booksCard'), booksList = el('booksList');
  const schedulesCard = el('schedulesCard'), schedulesArea = el('schedulesArea');
  const notice = el('notice');

  const timerMode = el('timerMode'), pomWork = el('pomWork'), pomBreak = el('pomBreak'), customMin = el('customMin');
  const timerText = el('timerText'), timerState = el('timerState');
  const startTimerBtn = el('startTimer'), pauseTimerBtn = el('pauseTimer'), skipTimerBtn = el('skipTimer'), resetTimerBtn = el('resetTimer');
  const notifyChk = el('notifyChk'), soundChk = el('soundChk'), sessionCountEl = el('sessionCount');

  const clearBooksBtn = el('clearBooks'), exportAllCsvBtn = el('exportAllCsv'), exportAllPdfBtn = el('exportAllPdf');
  const downloadAllCsv = el('downloadAllCsv'), downloadAllPdf = el('downloadAllPdf');

  const resetSessionsBtn = el('resetSessions'), resetSchedulesBtn = el('resetSchedules'), resetAllBtn = el('resetAll');
  const startDateInput = el('startDate'), restDaysSelect = el('restDays'), intervalsInput = el('intervals');

  // ----- util -----
  const uid = () => 'id_' + Math.random().toString(36).slice(2,10);
  const saveState = () => {
    localStorage.setItem(K_BOOKS, JSON.stringify(state.books));
    localStorage.setItem(K_SCHEDULES, JSON.stringify(state.schedules));
    localStorage.setItem(K_SESSIONS, String(state.sessions));
    localStorage.setItem(K_SETTINGS, JSON.stringify(state.settings));
  };
  const showNotice = (txt, ms = 2200) => {
    notice.textContent = txt; notice.style.display = 'block';
    setTimeout(()=> notice.style.display = 'none', ms);
  };
  const escapeHtml = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  // ----- initial UI hydrate -----
  function initUI(){
    if(state.settings.dark) document.body.classList.add('dark');
    if(state.settings.notify) notifyChk.checked = true;
    if(state.settings.sound !== undefined) soundChk.checked = state.settings.sound;

    renderBooks();
    renderSchedules();
    updateSessionUI();
    onTimerModeChange();
  }

  // ----- Books -----
  function renderBooks(){
    if(!state.books.length){ booksCard.style.display = 'none'; booksList.innerHTML = ''; return; }
    booksCard.style.display = 'block';
    booksList.innerHTML = '';
    state.books.forEach(b => {
      const li = document.createElement('li'); li.className = 'book-item';
      li.innerHTML = `<div class="book-meta"><div class="title">${escapeHtml(b.name)}</div><div class="meta">${b.total} ØµÙØ­Ø© â€” ${b.daily}/ÙŠÙˆÙ…</div></div>
        <div style="display:flex;gap:6px">
          <button class="btn ghost small" data-act="edit" data-id="${b.id}"><i class="fas fa-edit"></i></button>
          <button class="btn ghost small" data-act="del" data-id="${b.id}"><i class="fas fa-trash"></i></button>
        </div>`;
      booksList.appendChild(li);
    });
    // update stats
    el('statTotal') && (el('statTotal').textContent = state.schedules.length || 0);
  }

  function addBookFromForm(){
    const name = el('bookName').value.trim();
    const total = parseInt(el('bookTotal').value,10);
    const daily = parseInt(el('bookDaily').value,10);
    const startDate = startDateInput.value ? startDateInput.value : null;
    const restDays = Array.from(restDaysSelect.selectedOptions).map(o=>parseInt(o.value,10));
    const intervals = (intervalsInput.value || '').split(',').map(x=>parseInt(x.trim())).filter(n=>!isNaN(n) && n>0).sort((a,b)=>a-b);
    if(!name || !total || !daily){ alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨ ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ ØµÙØ­Ø§Øª ÙˆØ¹Ø¯Ø¯ ØµÙØ­Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹ ØµØ­ÙŠØ­'); return; }
    const b = { id: uid(), name, total, daily, startDate, restDays, intervals };
    state.books.push(b); saveState();
    renderBooks(); showNotice('âœ… Ø£Ø¶ÙŠÙ Ø§Ù„ÙƒØªØ§Ø¨');
    el('bookName').value=''; el('bookTotal').value='200'; el('bookDaily').value='10';
  }

  // books list delegation
  booksList.addEventListener('click', e=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.dataset.act, id = btn.dataset.id;
    if(act === 'edit') editBook(id);
    if(act === 'del') deleteBook(id);
  });

  function editBook(id){
    const b = state.books.find(x=>x.id===id); if(!b) return;
    const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨', b.name); if(newName === null) return;
    const newTotal = parseInt(prompt('ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙØ­Ø§Øª', b.total),10);
    const newDaily = parseInt(prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹', b.daily),10);
    if(!newName || !newTotal || !newDaily){ alert('Ù‚ÙŠÙ… ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; }
    b.name = newName.trim(); b.total = newTotal; b.daily = newDaily;
    saveState(); renderBooks(); showNotice('âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
  }
  function deleteBook(id){
    if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨ ÙˆÙƒÙ„ Ø¬Ø¯ÙˆÙ„Ø§ØªÙ‡ØŸ')) return;
    state.books = state.books.filter(b=>b.id!==id);
    state.schedules = state.schedules.filter(s=>s.bookId!==id);
    saveState(); renderBooks(); renderSchedules(); showNotice('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
  }

  // ----- Schedule generation -----
  function buildScheduleForBook(book){
    const intervals = book.intervals || [];
    const restDays = book.restDays || [];
    const start = book.startDate ? new Date(book.startDate + 'T00:00:00') : new Date();
    const totalPages = book.total, perDay = book.daily;
    const studyDaysCount = Math.ceil(totalPages / perDay);

    const calendar = [];
    let cur = new Date(start);
    let scheduledStudy = 0;
    while(scheduledStudy < studyDaysCount){
      const isRest = restDays.includes(cur.getDay());
      if(isRest){
        calendar.push({ date: new Date(cur), kind: 'rest' });
        cur.setDate(cur.getDate()+1);
        continue;
      }
      scheduledStudy++;
      calendar.push({ date: new Date(cur), kind: 'study', studyNo: scheduledStudy });
      cur.setDate(cur.getDate()+1);
    }
    const maxInterval = intervals.length ? Math.max(...intervals) : 0;
    let extraNeeded = maxInterval;
    while(extraNeeded > 0){
      const isRest = restDays.includes(cur.getDay());
      if(isRest){ calendar.push({ date: new Date(cur), kind: 'rest' }); cur.setDate(cur.getDate()+1); continue; }
      calendar.push({ date: new Date(cur), kind: 'extra' });
      cur.setDate(cur.getDate()+1);
      extraNeeded--;
    }

    const studyIndexToCalIndex = {};
    calendar.forEach((c, idx) => { if(c.kind === 'study') studyIndexToCalIndex[c.studyNo] = idx; });

    const entries = calendar.map((c, idx) => {
      if(c.kind === 'rest') return { date: c.date, type: 'Ø±Ø§Ø­Ø©', newPagesRange: null, reviewDetails: [], totalPages: 0, studyNo: null, completed: false, notes: '' };
      if(c.kind === 'study'){
        const sNo = c.studyNo;
        const startP = (sNo - 1) * perDay + 1;
        const endP = Math.min(sNo * perDay, totalPages);
        const reviews = [];
        for(let prev=1; prev<=studyDaysCount; prev++){
          const prevCalIndex = studyIndexToCalIndex[prev];
          intervals.forEach(interval => {
            if(prevCalIndex + interval === idx){
              const rs = (prev - 1) * perDay + 1;
              const re = Math.min(prev * perDay, totalPages);
              reviews.push({ fromStudy: prev, interval, pages: `Øµ${rs}-${re}` });
            }
          });
        }
        const totalForDay = (endP - startP + 1) + reviews.reduce((a,r)=>{
          const parts = r.pages.replace('Øµ','').split('-'); return a + (parseInt(parts[1]) - parseInt(parts[0]) + 1);
        },0);
        const dayType = (endP - startP + 1) > 0 && reviews.length > 0 ? 'Ø­ÙØ¸ ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø©' : (endP - startP + 1 > 0 ? 'Ø­ÙØ¸ Ø¬Ø¯ÙŠØ¯' : (reviews.length ? 'Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙ‚Ø·' : 'Ø±Ø§Ø­Ø©'));
        return { date: c.date, type: dayType, newPagesRange: `Øµ${startP}-${endP}`, reviewDetails: reviews, totalPages: totalForDay, studyNo: sNo, completed: false, notes: '' };
      }
      const reviews = [];
      const studyIndexToCal = studyIndexToCalIndex;
      for(let prev=1; prev<=studyDaysCount; prev++){
        const prevCalIndex = studyIndexToCal[prev];
        intervals.forEach(interval => {
          if(prevCalIndex + interval === idx){
            const rs = (prev - 1) * perDay + 1;
            const re = Math.min(prev * perDay, totalPages);
            reviews.push({ fromStudy: prev, interval, pages: `Øµ${rs}-${re}` });
          }
        });
      }
      const totalForDay = reviews.reduce((a,r)=>{
        const parts = r.pages.replace('Øµ','').split('-'); return a + (parseInt(parts[1]) - parseInt(parts[0]) + 1);
      },0);
      if(reviews.length) return { date: c.date, type: 'Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙ‚Ø·', newPagesRange: null, reviewDetails: reviews, totalPages: totalForDay, studyNo: null, completed: false, notes: '' };
      return { date: c.date, type: 'Ø±Ø§Ø­Ø©', newPagesRange: null, reviewDetails: [], totalPages: 0, studyNo: null, completed:false, notes:'' };
    });

    return entries;
  }

  function onGenerateClicked(){
    if(!state.books.length){ alert('Ø£Ø¶Ù ÙƒØªØ§Ø¨Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§'); return; }
    state.schedules = state.books.map(b => {
      const sched = buildScheduleForBook(b);
      return { bookId: b.id, bookName: b.name, schedule: sched };
    });
    saveState();
    renderSchedules();
    showNotice('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ­ÙØ¸Ù‡Ø§ Ù…Ø­Ù„ÙŠÙ‹Ø§');
  }

  // ----- render schedules UI -----
  function renderSchedules(){
    if(!state.schedules.length){ schedulesCard.style.display='none'; schedulesArea.innerHTML = ''; return; }
    schedulesCard.style.display = 'block';
    schedulesArea.innerHTML = '';
    state.schedules.forEach((s, sIdx) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'card';
      wrapper.style.marginBottom = '10px';
      const totalDays = s.schedule.length;
      const doneCount = s.schedule.filter(r => r.completed).length;
      const percent = totalDays ? Math.round((doneCount/totalDays)*100) : 0;

      let html = `<h4 style="margin:0 0 6px">${escapeHtml(s.bookName)}</h4>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div class="small">Ø£ÙŠØ§Ù… Ø§Ù„Ø®Ø·Ø©: <strong>${totalDays}</strong></div>
          <div class="small">Ù…Ù†Ø¬Ø²Ø©: <strong>${doneCount}</strong></div>
          <div class="small">Ø¥Ù†Ø¬Ø§Ø²: <strong>${percent}%</strong></div>
          <div style="margin-left:auto;display:flex;gap:6px">
            <button class="btn small ghost" data-book="${s.bookId}" data-act="export-csv">CSV</button>
            <button class="btn small ghost" data-book="${s.bookId}" data-act="export-pdf">PDF</button>
          </div>
        </div>`;

      html += `<div class="schedule-table-container" style="margin-top:8px"><table>
        <thead><tr><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>ØµÙØ­Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</th><th>Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>ØªØ­ÙƒÙ…</th></tr></thead><tbody>`;

      s.schedule.forEach((row, rIdx) => {
        const cls = row.completed ? 'done' : (row.type.includes('Ø­ÙØ¸') ? 'save' : (row.type.includes('Ù…Ø±Ø§Ø¬Ø¹Ø©') ? 'review' : (row.type.includes('Ø±Ø§Ø­Ø©') ? 'rest' : '')));
        const reviewsHtml = (row.reviewDetails && row.reviewDetails.length) ? row.reviewDetails.map(rd => `<div>${escapeHtml(rd.interval + 'ÙŠ: ' + rd.pages)}</div>`).join('') : '-';
        html += `<tr class="${cls}">
          <td>${row.studyNo || '-'}</td>
          <td>${new Date(row.date).toLocaleDateString('ar-EG')}</td>
          <td>${row.newPagesRange || '-'}</td>
          <td>${reviewsHtml}</td>
          <td>${row.totalPages || '-'}</td>
          <td>${escapeHtml(row.type)}</td>
          <td>
            <button class="btn small" data-act="done" data-book="${s.bookId}" data-idx="${rIdx}">âœ…</button>
            <button class="btn small ghost" data-act="edit" data-book="${s.bookId}" data-idx="${rIdx}">âœï¸</button>
            <button class="btn small ghost" data-act="del" data-book="${s.bookId}" data-idx="${rIdx}">ğŸ—‘</button>
          </td>
        </tr>`;
      });

      html += `</tbody></table></div>`;
      wrapper.innerHTML = html;
      schedulesArea.appendChild(wrapper);
    });
    // update small stats
    el('statDone') && (el('statDone').textContent = state.schedules.reduce((a,s)=> a + s.schedule.filter(r=>r.completed).length,0));
    el('statTotal') && (el('statTotal').textContent = state.schedules.length);
  }

  // schedule action delegation
  schedulesArea.addEventListener('click', e => {
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.dataset.act, bookId = btn.dataset.book, idx = btn.dataset.idx !== undefined ? parseInt(btn.dataset.idx,10) : null;
    if(act === 'done') markSessionDone(bookId, idx);
    if(act === 'edit') editSessionNote(bookId, idx);
    if(act === 'del') deleteSession(bookId, idx);
    if(act === 'export-csv') exportScheduleCSV(bookId);
    if(act === 'export-pdf') exportSchedulePDF(bookId);
  });

  function markSessionDone(bookId, rowIdx){
    const s = state.schedules.find(x=>x.bookId===bookId); if(!s) return;
    const row = s.schedule[rowIdx]; if(!row) return;
    if(row.completed){ alert('Ù…ÙˆØ³Ù… Ù…ÙØ¹Ù„Ù… Ø¨Ø§Ù„ÙØ¹Ù„'); return; }
    row.completed = true; state.sessions++;
    saveState(); renderSchedules(); updateSessionUI();
    notifyAndSound('Ø§Ù†ØªÙ‡Øª Ø¬Ù„Ø³Ø©', `${s.bookName} â€” ${row.newPagesRange || row.type}`);
  }
  function editSessionNote(bookId, rowIdx){
    const s = state.schedules.find(x=>x.bookId===bookId); if(!s) return;
    const row = s.schedule[rowIdx]; if(!row) return;
    const note = prompt('Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø¬Ù„Ø³Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', row.notes || '');
    if(note === null) return;
    row.notes = note; saveState(); renderSchedules(); showNotice('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
  }
  function deleteSession(bookId, rowIdx){
    if(!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ')) return;
    const s = state.schedules.find(x=>x.bookId===bookId); if(!s) return;
    s.schedule.splice(rowIdx,1); saveState(); renderSchedules(); showNotice('âœ… Ø­ÙØ°ÙØª Ø§Ù„Ø¬Ù„Ø³Ø©');
  }

  // ----- Export functions (CSV + PDF) -----
  function exportScheduleCSV(bookId){
    const s = state.schedules.find(x=>x.bookId===bookId); if(!s) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„');
    const rows = [['Ø§Ù„ÙŠÙˆÙ…','Ø§Ù„ØªØ§Ø±ÙŠØ®','ØµÙØ­Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©','Ù…Ø±Ø§Ø¬Ø¹Ø§Øª','Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹','Ø§Ù„Ù†ÙˆØ¹','Ù…Ù„Ø§Ø­Ø¸Ø§Øª']];
    s.schedule.forEach(r => rows.push([r.studyNo || '-', new Date(r.date).toLocaleDateString('ar-EG'), r.newPagesRange || '-', r.reviewDetails.map(x=>x.pages).join(' | ') || '-', r.totalPages || '-', r.type || '-', r.notes || '']));
    const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob(["\ufeff" + csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `${sanitizeFilename(s.bookName)}_schedule.csv`; a.click(); URL.revokeObjectURL(url);
    showNotice('âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„ CSV Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨');
  }

  function exportSchedulePDF(bookId){
    const wrappers = Array.from(schedulesArea.children);
    const idx = state.schedules.findIndex(s => s.bookId === bookId);
    if(idx === -1) return alert('Ø®Ø·Ø£');
    const el = wrappers[idx];
    if(!el) return alert('Ø®Ø·Ø£');
    exportElementPDF(el, `${sanitizeFilename(state.schedules[idx].bookName)}_schedule.pdf`);
  }

  function exportAllSchedulesCSV(){
    if(!state.schedules.length) return alert('Ù„Ø§ Ø¬Ø¯Ø§ÙˆÙ„');
    const rows = [];
    state.schedules.forEach(s => {
      rows.push([`ÙƒØªØ§Ø¨: ${s.bookName}`]);
      rows.push(['Ø§Ù„ÙŠÙˆÙ…','Ø§Ù„ØªØ§Ø±ÙŠØ®','ØµÙØ­Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©','Ù…Ø±Ø§Ø¬Ø¹Ø§Øª','Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹','Ø§Ù„Ù†ÙˆØ¹','Ù…Ù„Ø§Ø­Ø¸Ø§Øª']);
      s.schedule.forEach(r => rows.push([r.studyNo || '-', new Date(r.date).toLocaleDateString('ar-EG'), r.newPagesRange || '-', r.reviewDetails.map(x=>x.pages).join(' | '), r.totalPages || '-', r.type || '-', r.notes || '']));
      rows.push([]);
    });
    const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob(["\ufeff" + csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'all_schedules.csv'; a.click(); URL.revokeObjectURL(url);
    showNotice('âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„ CSV Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„');
  }

  async function exportElementPDF(element, filename='export.pdf'){
    try{
      showNotice('â³ Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² PDF...');
      const canvas = await html2canvas(element, { scale: 2, useCORS: true });
      const img = canvas.toDataURL('image/jpeg', 0.95);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'px', format:[canvas.width, canvas.height] });
      pdf.addImage(img, 'JPEG', 0, 0, canvas.width, canvas.height);
      pdf.save(filename);
      showNotice('âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„ PDF');
    }catch(err){
      console.error(err); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ PDF');
    }
  }

  // ----- Timer / Sessions -----
  function onTimerModeChange(){
    const v = timerMode.value;
    document.getElementById('pom').style.display = v === 'pomodoro' ? 'block' : 'none';
    document.getElementById('custom').style.display = v === 'custom' ? 'block' : 'none';
    state.settings.timerMode = v; saveState();
  }
  timerMode.addEventListener('change', onTimerModeChange);

  function startTimer(){
    if(state.timer.running) return;
    const mode = timerMode.value;
    if(mode === 'pomodoro'){
      if(!state.timer.timeLeft) { state.timer.isWork = true; state.timer.timeLeft = (parseInt(pomWork.value,10) || 25) * 60; }
    } else if(mode === 'custom'){
      if(!state.timer.timeLeft) state.timer.timeLeft = (parseInt(customMin.value,10) || 30) * 60;
    } else {
      if(!state.timer.timeLeft) state.timer.timeLeft = (parseInt(customMin.value,10) || 60) * 60;
    }
    state.timer.running = true; timerState.textContent = state.timer.isWork ? 'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„' : 'Ø§Ø³ØªØ±Ø§Ø­Ø©';
    state.timer.intervalId = setInterval(()=> {
      state.timer.timeLeft--;
      updateTimerUI();
      if(state.timer.timeLeft <= 0) onTimerFinish();
    }, 1000);
  }
  function pauseTimer(){ clearInterval(state.timer.intervalId); state.timer.running = false; timerState.textContent = 'Ù…ÙˆÙ‚ÙˆÙ Ù…Ø¤Ù‚ØªÙ‹Ø§'; }
  function skipTimer(){
    const mode = timerMode.value;
    clearInterval(state.timer.intervalId); state.timer.running = false;
    if(mode === 'pomodoro'){
      state.timer.isWork = !state.timer.isWork;
      state.timer.timeLeft = (state.timer.isWork ? (parseInt(pomWork.value,10) || 25) : (parseInt(pomBreak.value,10) || 5)) * 60;
      timerState.textContent = state.timer.isWork ? 'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„' : 'Ø§Ø³ØªØ±Ø§Ø­Ø©';
      updateTimerUI();
    } else {
      state.timer.timeLeft = 0; updateTimerUI();
    }
  }
  function resetTimer(){
    clearInterval(state.timer.intervalId);
    state.timer.running = false; state.timer.timeLeft = 0; state.timer.isWork = true; timerState.textContent = 'Ù…ØªÙˆÙ‚Ù';
    updateTimerUI();
  }
  function onTimerFinish(){
    clearInterval(state.timer.intervalId); state.timer.running = false;
    state.sessions++; saveState(); updateSessionUI();
    notifyAndSound('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©', 'Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© Ø§Ù„Ø¹Ù…Ù„/Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©');
    if(timerMode.value === 'pomodoro'){
      state.timer.isWork = !state.timer.isWork;
      state.timer.timeLeft = (state.timer.isWork ? (parseInt(pomWork.value,10) || 25) : (parseInt(pomBreak.value,10) || 5)) * 60;
      startTimer();
    } else {
      state.timer.timeLeft = 0; updateTimerUI(); timerState.textContent = 'Ø§Ù†ØªÙ‡Øª';
    }
  }
  function updateTimerUI(){
    const mm = Math.floor(Math.max(0,state.timer.timeLeft)/60);
    const ss = Math.max(0,state.timer.timeLeft)%60;
    timerText.textContent = `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  }
  function notifyAndSound(title, body){
    if(notifyChk.checked){
      if("Notification" in window && Notification.permission === 'granted') new Notification(title, {body});
      else if("Notification" in window && Notification.permission !== 'denied') Notification.requestPermission();
    }
    if(soundChk.checked) playBeep();
  }
  function playBeep(){
    try{
      const actx = new (window.AudioContext || window.webkitAudioContext)();
      const o = actx.createOscillator(); const g = actx.createGain();
      o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.001;
      o.connect(g); g.connect(actx.destination); o.start();
      g.gain.exponentialRampToValueAtTime(0.2, actx.currentTime + 0.02);
      setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime + 0.15); o.stop(actx.currentTime + 0.16); }, 150);
    }catch(e){ console.warn('Audio err', e); }
  }

  // ----- Sessions & stats UI -----
  function updateSessionUI(){
    sessionCountEl.textContent = state.sessions;
    saveState();
  }

  // ----- Reset buttons -----
  function resetSessions(){ if(!confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª (Ø³ÙŠØ­Ø°Ù Ø§Ù„Ø¹Ø¯Ø¯)ØŸ')) return; state.sessions = 0; saveState(); updateSessionUI(); showNotice('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª'); }
  function resetSchedules(){ if(!confirm('Ø­Ø°Ù Ø§Ù„ÙƒØªØ¨ ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„ØŸ')) return; state.books = []; state.schedules = []; saveState(); renderBooks(); renderSchedules(); showNotice('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒØªØ¨ ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„'); }
  function resetAll(){ if(!confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø´Ø§Ù…Ù„Ø© (Ø¬Ø¯Ø§ÙˆÙ„ØŒ Ø¬Ù„Ø³Ø§ØªØŒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)ØŸ')) return; state.books = []; state.schedules = []; state.sessions = 0; state.settings = {}; saveState(); renderBooks(); renderSchedules(); updateSessionUI(); showNotice('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©'); }

  // ----- misc helpers -----
  function sanitizeFilename(s){ return (s||'file').replace(/[^\w\-\.\s]/g,'_'); }
  function sanitize(str){ return String(str||'').replace(/"/g,'""'); }

  // ----- wire up top-level buttons -----
  addBtn.addEventListener('click', addBookFromForm);
  generateBtn.addEventListener('click', onGenerateClicked);
  darkBtn.addEventListener('click', () => { document.body.classList.toggle('dark'); state.settings.dark = document.body.classList.contains('dark'); saveState(); });
  clearBooksBtn.addEventListener('click', () => { if(!confirm('Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ÙƒØªØ¨ØŸ')) return; state.books = []; state.schedules = []; saveState(); renderBooks(); renderSchedules(); showNotice('âœ… Ù…Ø­ÙŠÙ‘Øª Ø§Ù„ÙƒØªØ¨'); });
  exportAllCsvBtn.addEventListener('click', exportAllSchedulesCSV);
  exportAllPdfBtn.addEventListener('click', () => exportElementPDF(document.querySelector('#schedulesArea') || document.body, 'all_schedules.pdf'));
  downloadAllCsv.addEventListener('click', exportAllSchedulesCSV);
  downloadAllPdf.addEventListener('click', () => exportElementPDF(document.querySelector('#schedulesArea') || document.body, 'all_schedules.pdf'));

  startTimerBtn.addEventListener('click', startTimer);
  pauseTimerBtn.addEventListener('click', pauseTimer);
  skipTimerBtn.addEventListener('click', skipTimer);
  resetTimerBtn.addEventListener('click', resetTimer);
  resetSessionsBtn.addEventListener('click', resetSessions);
  resetSchedulesBtn.addEventListener('click', resetSchedules);
  resetAllBtn.addEventListener('click', resetAll);

  // Expose export functions used in delegation (for console)
  window.exportScheduleCSV = exportScheduleCSV;
  window.exportSchedulePDF = exportSchedulePDF;

  // ----- initial render + loading saved schedules if any -----
  (function initialLoad(){
    state.settings = JSON.parse(localStorage.getItem(K_SETTINGS) || JSON.stringify(state.settings || {}));
    renderBooks();
    renderSchedules();
    updateSessionUI();
  })();

  // expose state for debugging
  window._sr_state = state;

})();
</script>
</body>
</html>